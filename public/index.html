<!doctype html>
<html lang="id" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Katheryne â€” Reduce Image by Resolution</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.08); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900 text-slate-100">
  <div class="max-w-3xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-extrabold tracking-tight">ðŸª„ Reduce Image by Resolution</h1>
      <p class="text-slate-300 mt-1">Upload gambar â†’ pilih resolusi â†’ kompres & resize di server (Sharp).</p>
    </header>

    <section class="glass rounded-2xl p-5 shadow-xl">
      <!-- Uploader -->
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-2 font-semibold">Pilih Gambar</label>
          <div id="drop" class="border-2 border-dashed border-slate-600 rounded-xl p-6 text-center cursor-pointer hover:border-indigo-400">
            <input id="file" type="file" accept="image/*" class="hidden" />
            <p class="text-slate-300">Tarik file ke sini atau klik untuk memilih</p>
          </div>
          <div id="preview" class="mt-3 hidden">
            <img id="previewImg" class="rounded-lg max-h-56 object-contain mx-auto" />
            <p id="meta" class="text-xs text-center text-slate-400 mt-2"></p>
          </div>
        </div>

        <div>
          <label class="block text-sm mb-2 font-semibold">Preset Resolusi</label>
          <select id="preset" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2">
            <option value="original">Original (no resize)</option>
            <option value="4096">4096 px (lebar)</option>
            <option value="3840">3840 px (4K width)</option>
            <option value="2560">2560 px</option>
            <option value="2048">2048 px</option>
            <option value="1920">1920 px (Full HD width)</option>
            <option value="1600">1600 px</option>
            <option value="1280">1280 px</option>
            <option value="1024">1024 px</option>
            <option value="800">800 px</option>
            <option value="640">640 px</option>
            <option value="custom">Customâ€¦</option>
          </select>

          <div id="customBox" class="mt-3 hidden">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-xs">Width (px)</label>
                <input id="width" type="number" min="1" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2" placeholder="mis. 1200" />
              </div>
              <div>
                <label class="text-xs">Height (px)</label>
                <input id="height" type="number" min="1" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2" placeholder="optional" />
              </div>
            </div>
            <p class="text-xs text-slate-400 mt-1">Default <b>fit=inside</b> (aspek terjaga, tanpa pembesaran berlebihan).</p>
          </div>

          <div class="mt-3">
            <label class="block text-sm mb-2 font-semibold">Kualitas (1-100)</label>
            <input id="quality" type="range" min="1" max="100" value="82" class="w-full">
            <div class="text-xs text-slate-400 mt-1">Format berpengaruh: JPEG/WEBP/AVIF menghormati kualitas, PNG akan lossless-ish.</div>
          </div>

          <div class="mt-3">
            <label class="block text-sm mb-2 font-semibold">Format Output</label>
            <select id="format" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2">
              <option value="auto">Auto (ikut input)</option>
              <option value="jpeg">JPEG</option>
              <option value="png">PNG</option>
              <option value="webp">WEBP</option>
              <option value="avif">AVIF</option>
            </select>
          </div>
        </div>
      </div>

      <div class="mt-5 flex items-center gap-3">
        <button id="go" class="bg-indigo-600 hover:bg-indigo-500 active:scale-[.99] transition px-4 py-2 rounded-lg font-semibold">Reduce</button>
        <div id="status" class="text-sm text-slate-300"></div>
      </div>
    </section>

    <section id="resultBox" class="glass rounded-2xl p-5 shadow-xl mt-6 hidden">
      <h2 class="text-xl font-bold mb-3">Hasil</h2>
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <img id="outImg" class="rounded-lg max-h-64 object-contain mx-auto" />
        </div>
        <div class="text-sm">
          <p id="outMeta" class="text-slate-300"></p>
          <div class="mt-3 flex gap-3">
            <a id="download" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-lg font-semibold" download>Download</a>
            <button id="reset" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-semibold">Ulangi</button>
          </div>
        </div>
      </div>
    </section>

    <footer class="mt-10 text-center text-xs text-slate-500">
      Built for Katheryne â€” Serverless on Vercel, powered by Sharp ðŸ’œ
    </footer>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const fileInput = $("#file");
    const drop = $("#drop");
    const preset = $("#preset");
    const customBox = $("#customBox");
    const widthI = $("#width");
    const heightI = $("#height");
    const quality = $("#quality");
    const format = $("#format");
    const go = $("#go");
    const statusEl = $("#status");
    const preview = $("#preview");
    const previewImg = $("#previewImg");
    const meta = $("#meta");
    const resultBox = $("#resultBox");
    const outImg = $("#outImg");
    const outMeta = $("#outMeta");
    const downloadA = $("#download");
    const resetBtn = $("#reset");

    // Drag & drop
    drop.addEventListener("click", () => fileInput.click());
    drop.addEventListener("dragover", e => { e.preventDefault(); drop.classList.add("border-indigo-400"); });
    drop.addEventListener("dragleave", e => { drop.classList.remove("border-indigo-400"); });
    drop.addEventListener("drop", (e) => {
      e.preventDefault();
      drop.classList.remove("border-indigo-400");
      if (e.dataTransfer.files?.[0]) {
        fileInput.files = e.dataTransfer.files;
        showPreview();
      }
    });
    fileInput.addEventListener("change", showPreview);

    preset.addEventListener("change", () => {
      customBox.classList.toggle("hidden", preset.value !== "custom");
    });

    function showPreview() {
      const f = fileInput.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      previewImg.src = url;
      preview.classList.remove("hidden");
      const kb = (f.size / 1024).toFixed(1);
      const img = new Image();
      img.onload = () => {
        meta.textContent = `Input: ${img.width}x${img.height}px â€¢ ${(kb)} KB â€¢ ${f.type || f.name}`;
      };
      img.src = url;
    }

    async function reduce() {
      const f = fileInput.files?.[0];
      if (!f) return alert("Pilih file dulu ya.");

      statusEl.textContent = "Processingâ€¦";
      go.disabled = true;

      const fd = new FormData();
      fd.append("file", f, f.name);
      fd.append("preset", preset.value);
      if (preset.value === "custom") {
        if (widthI.value) fd.append("width", widthI.value);
        if (heightI.value) fd.append("height", heightI.value);
      }
      fd.append("quality", quality.value);
      fd.append("format", format.value);
      fd.append("fit", "inside");

      const resp = await fetch("/api/resize", { method: "POST", body: fd });
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        statusEl.textContent = "";
        go.disabled = false;
        return alert("Gagal: " + (err.error || resp.statusText));
      }

      const blob = await resp.blob();
      const outUrl = URL.createObjectURL(blob);
      outImg.src = outUrl;
      downloadA.href = outUrl;

      // Ambil metadata dari header
      const width = resp.headers.get("x-image-width");
      const height = resp.headers.get("x-image-height");
      const size = resp.headers.get("x-image-size");
      const sizeKB = size ? (parseInt(size, 10) / 1024).toFixed(1) : "";
      outMeta.textContent = `Output: ${width}x${height}px â€¢ ${sizeKB} KB â€¢ ${resp.headers.get("content-type")}`;

      statusEl.textContent = "Selesai.";
      resultBox.classList.remove("hidden");
      go.disabled = false;
    }

    go.addEventListener("click", reduce);
    resetBtn.addEventListener("click", () => {
      resultBox.classList.add("hidden");
      statusEl.textContent = "";
      outImg.src = "";
      downloadA.removeAttribute("href");
    });
  </script>
</body>
</html>
